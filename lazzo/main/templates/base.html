{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>{% block title %}Lazzo{% endblock %}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{% static 'css/styles.css' %}">
    <link rel="shortcut icon" type="image/png" href="{% static 'img/favicon.ico' %}">
    {% block extra_head %}{% endblock %}
</head>
<body>

    <!-- Top bar -->
    <div class="top-bar">
        <div class="container top-bar-content">
            <div>
                <a href="{% url 'acerca' %}#ayuda">Ayuda</a>
                <a href="{% url 'acerca' %}#seguimiento-compra">Seguimiento de compra</a>
                <a href="{% url 'acerca' %}#sucursales">Sucursales</a>
            </div>

            <div>
                {% if request.session.usuario_id %}
                    <div class="user-menu">
                        <button type="button" class="user-menu-toggle">
                            <img src="{% static 'img/user.png' %}" alt="user" width="20">
                            <span class="header-user">
                                Hola, {{ request.session.usuario_nombre }}
                            </span>
                            <span class="user-menu-caret">▾</span>
                        </button>

                        <div class="user-menu-dropdown">
                            <div class="user-menu-header">
                                <strong>{{ request.session.usuario_nombre }}</strong>
                                <span class="user-menu-role">
                                    {{ request.session.usuario_rol|title }}
                                </span>
                            </div>

                            {# Perfil público (cliente o vendedor) #}
                            <a href="{% url 'mi_perfil' %}" class="user-menu-link">Mi perfil</a>

                            {# Configuración / edición de datos de cuenta #}
                            <a href="{% url 'mi_cuenta' %}" class="user-menu-link">Editar cuenta</a>

                            <a href="{% url 'pedidos' %}" class="user-menu-link">Mis compras</a>
                            <a href="{% url 'favoritos' %}" class="user-menu-link">Favoritos</a>
                            <a href="{% url 'mensajes' %}" class="user-menu-link">Mensajes</a>
                            <a href="{% url 'notificaciones' %}" class="user-menu-link">Notificaciones</a>

                            {% if request.session.usuario_rol == 'vendedor' %}
                                <a href="{% url 'producto_crear' %}" class="user-menu-link">
                                    Añadir producto
                                </a>
                            {% endif %}

                            <form method="post" action="{% url 'logout' %}" class="user-menu-logout">
                                {% csrf_token %}
                                <button type="submit" class="user-menu-logout-btn">
                                    Cerrar sesión
                                </button>
                            </form>
                        </div>
                    </div>
                {% else %}
                    <a href="{% url 'login' %}">Iniciar sesión</a>
                    <a href="{% url 'registro' %}">Crear cuenta</a>
                {% endif %}
            </div>
        </div>
    </div>


    <!-- Header principal -->
    <header class="main-header">
        <div class="container header-content">
            <div class="logo">
                <a href="{% url 'home' %}">Lazzo</a>
            </div>

            <div class="search-bar">
                <input 
                    type="text" 
                    name="q" 
                    form="searchForm"
                    placeholder="¿Qué estás buscando?"
                    value="{{ query|default:'' }}"
                >
                <button type="submit" form="searchForm">Buscar</button>

                <form id="searchForm" method="GET" action="{% url 'buscar' %}"></form>
            </div>

            <div class="header-icons">
                <a href="{% url 'pedidos' %}" class="header-icon">Mis compras</a>
                <a href="{% url 'favoritos' %}" class="header-icon">Favoritos</a>

                <!-- WRAPPER DEL CARRO CON MINI-CARRITO -->
                <div class="cart-icon-wrapper">
                    <a href="{% url 'cart' %}" class="header-icon cart-icon">
                        Carro ({{ carrito_cantidad|default:"0" }})
                    </a>

                    <div class="mini-cart-dropdown">
                        {% if carrito_cantidad %}
                            <ul class="mini-cart-items">
                                {% for item in carrito_items_preview %}
                                    <li class="mini-cart-item">
                                        {% if item.imagen %}
                                            <img src="{{ item.imagen }}" alt="{{ item.nombre }}" class="mini-cart-thumb">
                                        {% else %}
                                            <div class="mini-cart-thumb mini-cart-thumb-placeholder"></div>
                                        {% endif %}

                                        <div class="mini-cart-item-info">
                                            <span class="mini-cart-item-name">{{ item.nombre }}</span>
                                            <span class="mini-cart-item-qty">x{{ item.cantidad }}</span>
                                            <span class="mini-cart-item-subtotal">${{ item.subtotal }}</span>
                                        </div>
                                    </li>
                                {% endfor %}
                            </ul>

                            <div class="mini-cart-footer">
                                <div class="mini-cart-total">
                                    <span>Total estimado</span>
                                    <span>${{ carrito_total_preview }}</span>
                                </div>
                                <div class="mini-cart-actions">
                                    <a href="{% url 'cart' %}" class="btn-secondary btn-small">Ver carrito</a>
                                    <a href="{% url 'checkout' %}" class="btn-primary btn-small">Ir a pagar</a>
                                </div>
                            </div>
                        {% else %}
                            <div class="mini-cart-empty">
                                Tu carrito está vacío.
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </header>

    {% if messages %}
    <div class="messages-wrapper">
        {% for message in messages %}
            <div class="alert-message {{ message.tags }}">
                {{ message }}
            </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Menú de categorías -->
    <nav class="main-nav">
        <div class="container nav-content">

            <!-- Dropdown de PRODUCTOS -->
            <div class="nav-dropdown">
                <button type="button" class="nav-link nav-toggle">
                    Productos ▾
                </button>
                <div class="nav-dropdown-menu">
                    <a href="{% url 'categoria_list' 'producto' 'ropa' %}">Ropa</a>
                    <a href="{% url 'categoria_list' 'producto' 'accesorios' %}">Accesorios</a>
                    <a href="{% url 'categoria_list' 'producto' 'tecnologia' %}">Tecnología</a>
                    <a href="{% url 'categoria_list' 'producto' 'hogar' %}">Hogar</a>
                    <a href="{% url 'categoria_list' 'producto' 'bebidas' %}">Bebidas</a>
                    <a href="{% url 'categoria_list' 'producto' 'alimentos' %}">Alimentos</a>
                    <a href="{% url 'categoria_list' 'producto' 'libros' %}">Libros</a>
                    <a href="{% url 'categoria_list' 'producto' 'gaming' %}">Gaming</a>
                    <a href="{% url 'categoria_list' 'producto' 'cuidado_personal' %}">Cuidado personal</a>
                    <a href="{% url 'categoria_list' 'producto' 'decoracion' %}">Decoración</a>
                </div>
            </div>

            <!-- Dropdown de SERVICIOS -->
            <div class="nav-dropdown">
                <button type="button" class="nav-link nav-toggle">
                    Servicios ▾
                </button>
                <div class="nav-dropdown-menu">
                    <a href="{% url 'categoria_list' 'servicio' 'mantenimiento' %}">Mantenimiento</a>
                    <a href="{% url 'categoria_list' 'servicio' 'reparacion' %}">Reparación</a>
                    <a href="{% url 'categoria_list' 'servicio' 'consultoria' %}">Consultoría</a>
                    <a href="{% url 'categoria_list' 'servicio' 'asesoria' %}">Asesoría</a>
                    <a href="{% url 'categoria_list' 'servicio' 'instalacion' %}">Instalación</a>
                    <a href="{% url 'categoria_list' 'servicio' 'clases' %}">Clases / Tutorías</a>
                    <a href="{% url 'categoria_list' 'servicio' 'transporte' %}">Transporte</a>
                    <a href="{% url 'categoria_list' 'servicio' 'eventos' %}">Eventos</a>
                    <a href="{% url 'categoria_list' 'servicio' 'marketing' %}">Marketing</a>
                </div>
            </div>

        </div>
    </nav>

    <!-- CONTENIDO VARIABLE -->
    <main>
        {% block content %}
        {% endblock %}
    </main>

    <!-- Footer -->
    <footer class="main-footer">
        <div class="container footer-content">
            <div class="footer-column">
                <h4>Atención al cliente</h4>
                <a href="{% url 'acerca' %}#faq">Preguntas frecuentes</a>
                <a href="{% url 'acerca' %}#terminos">Términos y condiciones</a>
                <a href="{% url 'acerca' %}#privacidad">Política de privacidad</a>
            </div>
            <div class="footer-column">
                <h4>Sobre nosotros</h4>
                <a href="{% url 'acerca' %}#quienes-somos">Quiénes somos</a>
                <a href="{% url 'acerca' %}#trabaja-con-nosotros">Trabaja con nosotros</a>
                <a href="{% url 'acerca' %}#sostenibilidad">Sostenibilidad</a>
            </div>
            <div class="footer-column">
                <h4>Medios de pago</h4>
                <p>Visa, Mastercard, Débito, etc.</p>
            </div>
            <div class="footer-column">
                <h4>Suscríbete</h4>
                <p>Recibe ofertas y novedades en tu correo.</p>
                <form class="newsletter-form">
                    <input type="email" placeholder="Ingresa tu correo">
                    <button type="submit">Enviar</button>
                </form>
            </div>
        </div>
        <div class="footer-bottom">
            <div class="container">
                <p>© 2025 Marketplace Lazzo.</p>
            </div>
        </div>
    </footer>

    {% block extra_scripts %}
    <script>
    document.addEventListener('DOMContentLoaded', function () {
        // ===== Menú de usuario en top bar =====
        const userMenu = document.querySelector('.user-menu');
        if (userMenu) {
            const userToggle = userMenu.querySelector('.user-menu-toggle');

            userToggle.addEventListener('click', function (e) {
                e.stopPropagation();
                userMenu.classList.toggle('open');
            });

            document.addEventListener('click', function () {
                userMenu.classList.remove('open');
            });
        }

        // ===== Mensajes flash (Django messages) =====
        const alerts = document.querySelectorAll('.alert-message');

        alerts.forEach(function (alert, index) {
            setTimeout(function () {
                alert.classList.add('show');
            }, 40 + index * 80);

            setTimeout(function () {
                alert.classList.add('hide');
            }, 4000 + index * 200);

            setTimeout(function () {
                if (alert && alert.parentNode) {
                    alert.parentNode.removeChild(alert);
                }
            }, 4600 + index * 200);
        });

        // ===== Menús desplegables de navegación (Productos / Servicios) =====
        const navDropdowns = document.querySelectorAll('.nav-dropdown');

        navDropdowns.forEach(function (dropdown) {
            const toggle = dropdown.querySelector('.nav-toggle');
            const menu = dropdown.querySelector('.nav-dropdown-menu');

            if (!toggle || !menu) return;

            toggle.addEventListener('click', function (e) {
                e.stopPropagation();

                navDropdowns.forEach(function (d) {
                    if (d !== dropdown) d.classList.remove('open');
                });

                dropdown.classList.toggle('open');
            });
        });

        document.addEventListener('click', function () {
            navDropdowns.forEach(function (d) {
                d.classList.remove('open');
            });
        });
    });
    </script>
    {% endblock %}

</body>
</html>
